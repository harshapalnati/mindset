#!/bin/bash

# Mindset AI - Command Line Interface
# Usage: mindset [command] [options]

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="${SCRIPT_DIR}"

# Function to print colored output
print_info() {
    echo -e "${BLUE}[mindset]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[mindset]${NC} $1"
}

print_error() {
    echo -e "${RED}[mindset]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[mindset]${NC} $1"
}

# Show help
show_help() {
    cat << 'EOF'
╔═══════════════════════════════════════════════════════════════╗
║                  Mindset AI CLI                               ║
╚═══════════════════════════════════════════════════════════════╝

Usage: mindset <command> [options]

Commands:
  setup              Run interactive setup wizard
  train              Fine-tune a model with your data
  start              Start the Mindset server
  console            Start interactive Elixir console
  status             Check server and model status
  models             List available fine-tuned models
  switch <model-id>  Switch to a different model
  stop               Stop the running server
  logs               Show server logs
  test               Run test inference
  help               Show this help message

Examples:
  mindset setup                    # First-time setup
  mindset train                    # Interactive training wizard
  mindset train --data data.csv    # Quick train with data
  mindset start                    # Start server
  mindset status                   # Check system status

EOF
}

# Check if we're in the right directory
check_project() {
    if [ ! -f "${PROJECT_DIR}/mix.exs" ]; then
        print_error "Not in a Mindset project directory!"
        print_info "Please run this command from the Mindset project root."
        exit 1
    fi
}

# Check if Elixir/Mix is available
check_elixir() {
    if ! command -v mix &> /dev/null; then
        print_error "Elixir/Mix not found!"
        print_info "Please install Elixir: https://elixir-lang.org/install.html"
        exit 1
    fi
}

# Setup command
cmd_setup() {
    print_info "Running Mindset setup wizard..."
    cd "${PROJECT_DIR}"
    mix mindset.setup
}

# Train command
cmd_train() {
    print_info "Starting fine-tuning wizard..."
    cd "${PROJECT_DIR}"
    mix mindset.train "$@"
}

# Start command
cmd_start() {
    print_info "Starting Mindset server..."
    
    # Check if already running
    if pgrep -f "mix phx.server" > /dev/null 2>&1; then
        print_warning "Server is already running!"
        print_info "Visit: http://localhost:4000"
        exit 0
    fi
    
    cd "${PROJECT_DIR}"
    
    # Check for .env file
    if [ ! -f ".env" ]; then
        print_warning "No .env file found. Running setup first..."
        cmd_setup
    fi
    
    print_info "Loading environment..."
    export $(grep -v '^#' .env | xargs) 2>/dev/null || true
    
    print_success "Starting Phoenix server..."
    print_info "The server will be available at: ${CYAN}http://localhost:4000${NC}"
    print_info "Press Ctrl+C to stop\n"
    
    mix phx.server
}

# Console command
cmd_console() {
    print_info "Starting Elixir interactive console..."
    cd "${PROJECT_DIR}"
    iex -S mix
}

# Status command
cmd_status() {
    print_info "Checking Mindset status..."
    
    # Check Elixir version
    if command -v elixir &> /dev/null; then
        ELIXIR_VERSION=$(elixir --version | grep "Elixir" | awk '{print $2}')
        print_success "Elixir: ${ELIXIR_VERSION}"
    else
        print_error "Elixir not found"
    fi
    
    # Check if server is running
    if pgrep -f "mix phx.server" > /dev/null 2>&1; then
        print_success "Server: ${GREEN}Running${NC}"
        print_info "  URL: http://localhost:4000"
        
        # Try to get PID
        PID=$(pgrep -f "mix phx.server" | head -1)
        print_info "  PID: ${PID}"
    else
        print_warning "Server: ${YELLOW}Not running${NC}"
    fi
    
    # Check for models
    if [ -f "priv/models/registry.json" ]; then
        MODEL_COUNT=$(cat priv/models/registry.json | grep -o '"id"' | wc -l)
        print_success "Fine-tuned models: ${MODEL_COUNT}"
    else
        print_warning "No fine-tuned models found"
    fi
    
    # Check environment
    if [ -f ".env" ]; then
        MODEL_REPO=$(grep "AI_MODEL_REPO" .env | cut -d'=' -f2 || echo "not set")
        print_info "Active model: ${MODEL_REPO}"
    fi
}

# Models command
cmd_models() {
    print_info "Listing fine-tuned models..."
    cd "${PROJECT_DIR}"
    mix mindset.train --list
}

# Switch command
cmd_switch() {
    if [ -z "$1" ]; then
        print_error "Please provide a model ID"
        print_info "Usage: mindset switch <model-id>"
        print_info "Run 'mindset models' to see available models"
        exit 1
    fi
    
    print_info "Switching to model: $1"
    cd "${PROJECT_DIR}"
    mix mindset.train --switch "$1"
    
    print_success "Model switched. Restart the server to use it:"
    print_info "  mindset stop && mindset start"
}

# Stop command
cmd_stop() {
    print_info "Stopping Mindset server..."
    
    if pgrep -f "mix phx.server" > /dev/null 2>&1; then
        pkill -f "mix phx.server"
        print_success "Server stopped"
    else
        print_warning "Server was not running"
    fi
}

# Logs command
cmd_logs() {
    print_info "Showing server logs..."
    
    # Check for log file
    if [ -f "log/dev.log" ]; then
        tail -f log/dev.log
    else
        print_warning "No log file found"
        print_info "Start the server first: mindset start"
    fi
}

# Test command
cmd_test() {
    print_info "Running test inference..."
    cd "${PROJECT_DIR}"
    
    mix run -e "
    Application.ensure_all_started(:mindset)
    Process.sleep(3000)
    IO.puts('Testing AI...')
    result = Mindset.Ai.Daemon.predict('Hello, how are you?')
    IO.inspect(result)
    "
}

# Main command dispatcher
main() {
    check_project
    check_elixir
    
    case "${1:-}" in
        setup)
            cmd_setup
            ;;
        train)
            shift
            cmd_train "$@"
            ;;
        start)
            cmd_start
            ;;
        console|iex)
            cmd_console
            ;;
        status)
            cmd_status
            ;;
        models|list)
            cmd_models
            ;;
        switch)
            shift
            cmd_switch "$@"
            ;;
        stop)
            cmd_stop
            ;;
        logs)
            cmd_logs
            ;;
        test)
            cmd_test
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            if [ -z "$1" ]; then
                show_help
            else
                print_error "Unknown command: $1"
                print_info "Run 'mindset help' for usage"
                exit 1
            fi
            ;;
    esac
}

# Run main function
main "$@"